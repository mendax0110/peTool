name: Release Build macOS

on:
  push:
    branches:
      - main

env:
  BUILD_TYPE: Release

jobs:
  build:
    runs-on: macos-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Install CMake
        run: |
          brew install cmake

      - name: Initialize and Update Submodules
        run: |
          git submodule update --init --recursive

      - name: Configure Git and Set Upstream
        run: |
          git config --global user.email "actions@github.com"
          git config --global user.name "GitHub Actions"
          git remote set-url origin https://github.com/${{ github.repository }}
          git remote -v

      - name: Debug Submodule and Branches
        run: |
          git -C external/imgui status
          git -C external/imgui branch -a

      - name: Checkout ImGui docking branch
        if: runner.os == 'macos'
        run: |
          git -C external/imgui fetch --all || exit 1
          git -C external/imgui checkout docking || git -C external/imgui checkout -b docking origin/master || exit 1

      - name: Build with CMake
        run: cmake -B ${{github.workspace}}/build -DCMAKE_BUILD_TYPE=${{env.BUILD_TYPE}}

      - name: Build
        run: cmake --build ${{github.workspace}}/build --config ${{env.BUILD_TYPE}}

      - name: Prepare Release
        if: success()
        run: |
          mkdir -p release
          cp -r ${{github.workspace}}/build/* release/
          cp -r ${{github.workspace}}/docs/Doxygen release/
          # Add more commands to package other necessary files

      - name: Create Tag
        if: success()
        run: git tag -a v${{ github.run_number }} -m "Release version v${{ github.run_number }}"

      - name: Push Tag
        if: success()
        env:
          GITHUB_TOKEN: ${{ secrets.GH_TOKEN }}
        run: git push origin v${{ github.run_number }}

      - name: Upload Release Artifacts
        if: success()
        uses: actions/upload-artifact@v2
        with:
          name: peTool-macOS-${{ env.BUILD_TYPE }}
          path: release/
